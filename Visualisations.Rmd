---
title: "Visualisations"
author: "Melle Stephen Oudshoorn"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE, warning = FALSE, echo = FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(dplyr)
library(lubridate)
library(ggplot2)
library(forcats)

df <- read.csv("strava_data/cleaned_subset.csv")
df$activity_date <- as.Date(df$activity_date)

month_levels <- c("jan", "feb", "mrt", "apr", "mei", "jun", 
                  "jul", "aug", "sep", "okt", "nov", "dec")
```

# Descriptive statistics and tables

```{r heading of the information}
head(df)
head_df <- head(df)
```

```{r distance analysis}
# Calculate total distance per activity type
distance_summary <- df %>%
  group_by(activity_type) %>%
  summarise(
    total_distance_km = sum(distance, na.rm = TRUE) / 1000,
    count = n()
  )

# Overall total distance
cat("Total distance:", sum(df$distance, na.rm = TRUE) / 1000, "kilometers\n")

# Print distance per activity type using cat()
if ("Hardloopsessie" %in% distance_summary$activity_type) {
  cat("Total distance ran:", distance_summary$total_distance_km[distance_summary$activity_type == "Hardloopsessie"], "kilometers\n")
}

if ("Fietsrit" %in% distance_summary$activity_type) {
  cat("Total distance biked:", distance_summary$total_distance_km[distance_summary$activity_type == "Fietsrit"], "kilometers\n")
}
```

# Training Load statistics

```{r total distance per month of the most recent year}
monthly_activity_distance <- df %>%
  filter(year == max(df$year, na.rm = TRUE)) %>%
  group_by(month, activity_type) %>%
  summarise(total_distance = sum(distance, na.rm = TRUE) / 1000) %>%
  mutate(month = factor(month, levels = month_levels))

ggplot(data = monthly_activity_distance, aes(x = month, y = total_distance, fill = activity_type)) + 
  geom_bar(stat = "identity") +
  labs(
    title = paste("Total Distance per Month by Activity Type in", max(df$year, na.rm = TRUE)),
    x = "Month",
    y = "Distance (km)",
    fill = "Activity Type"
  ) +
  theme_minimal()
```

```{r elapsed time per month by activity in the most recent year}
monthly_activity_elapsed_time <- df %>%
  filter(year == max(df$year, na.rm = TRUE)) %>%
  group_by(month, activity_type) %>%
  summarise(total_elapsed_time = sum(elapsed_time, na.rm = TRUE) / 3600) %>%
  mutate(month = factor(month, levels = month_levels))

ggplot(data = monthly_activity_elapsed_time, aes(x = month, y = total_elapsed_time, fill = activity_type)) + 
  geom_bar(stat = "identity") +
  labs(
    title = paste("Total elapsed time per Month by Activity Type in", max(df$year, na.rm = TRUE)),
    x = "Month",
    y = "Elapsed time (hours)",
    fill = "Activity Type"
  ) +
  theme_minimal()
```

```{r total elasped time per weekday!}
weekday_levels <- c("ma", "di", "wo", "do", "vr", "za", "zo")

monthly_activity_elapsed_time <- df %>%
  group_by(weekday, activity_type) %>%
  summarise(total_elapsed_time = sum(elapsed_time, na.rm = TRUE) / 3600, .groups = "drop") %>%
  mutate(weekday = factor(weekday, levels = weekday_levels))

ggplot(data = monthly_activity_elapsed_time, aes(x = weekday, y = total_elapsed_time, fill = activity_type)) + 
  geom_bar(stat = "identity") +
  labs(
    title = "Total Elapsed Time per Weekday by Activity Type",
    x = "Weekday",
    y = "Elapsed Time (hours)",
    fill = "Activity Type"
  ) +
  theme_minimal()
```

```{r activity frequency by weekday and hour}
df %>%
  count(weekday, hour) %>%
  mutate(weekday = factor(weekday, levels = rev(weekday_levels))) %>%
  ggplot(aes(x = hour, y = weekday, fill = n)) +
  geom_tile(color = "white") +
  scale_fill_viridis_c() +
  labs(title = "Activity Heatmap", x = "Hour", y = "Weekday", fill = "Count") +
  scale_fill_gradient(low = "lightblue", high = "darkblue") +
  theme_minimal()
```

```{r cumulative distance over time}
df %>%
  arrange(activity_type, activity_date) %>%
  group_by(activity_type) %>%
  mutate(cumulative_distance = cumsum(distance / 1000)) %>%
  ggplot(aes(x = activity_date, y = cumulative_distance, color = activity_type)) +
  geom_line(size = 1) +
  labs(
    title = "Cumulative Distance Over Time by Activity Type",
    x = "Date", y = "Cumulative Distance (km)"
  ) +
  theme_minimal()
```

```{r activity frequency by moonth and year}
df %>%
  count(year, month) %>%
  mutate(month = factor(month, levels = month_levels)) %>%
  ggplot(aes(x = month, y = year, fill = n, label = n)) +
  geom_tile() +
  geom_text(aes(color = n > median(n)), size = 4) +   # dynamic text color
  scale_fill_gradient(low = "lightblue", high = "darkblue", name = "Activity Count") +  # fill legend kept
  scale_color_manual(values = c("black", "white"), guide = "none") +  # hide color legend for text
  labs(title = "Activity Frequency by Month and Year", x = "Month", y = "Year") +
  theme_minimal()

```

```{r activity duration distribution}
ggplot(df, aes(x = elapsed_time / 60)) +
  geom_histogram(binwidth = 10, fill = "steelblue", color = "white") +
  labs(title = "Distribution of Activity Duration", x = "Duration (minutes)", y = "Count") +
  theme_minimal()
```

# Performance statistics

```{r average heart rate by distance}
ggplot(data = df %>% filter(distance > 0), aes(x = distance / 1000, y = avg_heart_rate, color = activity_type)) +
  geom_point() +
  labs(
    y = "Average Heart rate",
    x = "Distance",
    title = "Average heart rate by distance"
    )
```

```{r heart rate versus speed}
ggplot(data = df %>% filter(activity_type == "Hardloopsessie"), 
       aes(x = avg_heart_rate, y = pace)) +
  geom_point(alpha = 0.6, color = "#2E8B57") +
  geom_smooth(method = "loess", se = FALSE, color = "black", linetype = "dashed") +
  scale_y_reverse() +  # Faster pace = lower value, so invert
  labs(
    y = "Pace (min/km)",
    x = "Average Heart Rate (bpm)",
    title = "Average Running Pace vs. Heart Rate",
    subtitle = "Per session (Hardloopsessie)"
  ) +
  xlim(120, 205) + 
  ylim(4, 8) +
  theme_minimal()

```

```{r distance of running sessions over time}
ggplot(df %>% filter(activity_type == "Hardloopsessie"), aes(x = as.Date(activity_date), y = distance/1000)) +
  geom_point(alpha = 0.5, color = "#2E8B57") +
  geom_smooth(method = "loess", se = TRUE, color = "black") +
  labs(
    title = "Distance Over Time",
    x = "Date",
    y = "Distance (km)"
  ) +
  theme_minimal()

```

```{r distribution of pace}
df %>%
  filter(activity_type == "Hardloopsessie", !is.na(pace)) %>%
  ggplot(aes(x = activity_type, y = pace)) +
  geom_violin(fill = "skyblue") +
  geom_boxplot(width = 0.1, fill = "white") +
  labs(title = "Distribution of Pace for Running Sessions", y = "Pace (min/km)") +
  theme_minimal()
```

```{r pace improvement over time}
df %>%
  filter(activity_type == "Hardloopsessie", !is.na(pace)) %>%
  ggplot(aes(x = activity_date, y = pace)) +
  geom_point(alpha = 0.5, color = "darkred") +
  geom_smooth(method = "loess", se = TRUE, color = "black") +
  scale_y_reverse() +
  labs(title = "Running Pace Over Time", y = "Pace (min/km)", x = "Date") +
  theme_minimal()

```

```{r training load proxy}
df %>%
  filter(activity_type == "Hardloopsessie") %>%
  mutate(training_stress = (distance_km * avg_heart_rate)) %>%
  ggplot(aes(x = activity_date, y = training_stress)) +
  geom_point(color = "tomato") +
  geom_smooth(method = "loess", color = 'maroon', se = TRUE) +
  labs(title = "Training Stress Over Time", y = "Stress (Distance Ã— HR)", x = "Date") +
  theme_minimal()
```

```{r}
df %>%
  filter(!is.na(avg_heart_rate)) %>%
  mutate(hr_zone = case_when(
    avg_heart_rate < 120 ~ "Zone 1",
    avg_heart_rate < 140 ~ "Zone 2",
    avg_heart_rate < 160 ~ "Zone 3",
    avg_heart_rate < 180 ~ "Zone 4",
    TRUE ~ "Zone 5"
  ),
  hr_zone = factor(hr_zone, levels = c("Zone 1", "Zone 2", "Zone 3", "Zone 4", "Zone 5"))) %>%
  count(hr_zone) %>%
  ggplot(aes(x = hr_zone, y = n, fill = hr_zone)) +
  geom_col() +
  labs(
    title = "Time Spent in Heart Rate Zones",
    subtitle = "Zone 1 = < 120, Zone 2 = < 140, Zone 3 = < 160, Zone 4 = < 180, Zone 5 = > 180",
    x = "Heart Rate Zone", y = "Activity Count", fill = "Heart Rate Zone"
  ) +
  theme_minimal()

```


# Regression stuff

```{r correlation matrix, message=FALSE}
library(GGally)

df_numeric <- df %>%
  select(pace, avg_heart_rate, distance_km, total_ascent, avg_power, avg_cadence) %>%
  na.omit()

ggpairs(df_numeric)
```